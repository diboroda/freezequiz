<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–Ω—è—Ç—å —Ä—É–∫—É - –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</title>
    <style>
        body { 
            font-family: sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            text-align: center; 
        }
        .container { 
            background: rgba(255,255,255,0.1); 
            padding: 40px; 
            border-radius: 15px; 
            backdrop-filter: blur(10px);
            max-width: 90%;
            width: 400px;
        }
        button { 
            background: #4CAF50; 
            color: white; 
            padding: 20px 40px; 
            font-size: 24px; 
            border: none; 
            border-radius: 50px; 
            cursor: pointer; 
            margin: 20px 0; 
            transition: all 0.3s;
        }
        button:hover { background: #45a049; transform: translateY(-2px); }
        button:disabled { background: #cccccc; cursor: not-allowed; transform: none; }
        #status { margin: 20px 0; min-height: 30px; font-size: 1.1em; }
        .success { color: #90EE90; }
        .info { color: #FFD700; }
        .error { color: #ff6b6b; }
        .debug { 
            background: rgba(0,0,0,0.3); 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
            font-size: 12px; 
            text-align: left;
        }
        .back-btn { background: #666; margin-top: 20px; font-size: 16px; padding: 10px 20px; }
    </style>
    
    <!-- –î–æ–±–∞–≤—å—Ç–µ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>üé§ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h1>
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å —Ä—É–∫—É –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å</p>
        
        <button id="raiseHandBtn">–ü–æ–¥–Ω—è—Ç—å —Ä—É–∫—É</button>
        
        <div id="status"></div>
        
        <!-- –ë–ª–æ–∫ –æ—Ç–ª–∞–¥–∫–∏ -->
        <div class="debug" id="debugInfo" style="display: none;">
            <strong>–û—Ç–ª–∞–¥–∫–∞:</strong>
            <div id="debugLog"></div>
        </div>
        
        <p><small>–í—ã –≤—Å—Ç–∞–Ω–µ—Ç–µ –≤ –æ—á–µ—Ä–µ–¥—å. –î–æ–∂–¥–∏—Ç–µ—Å—å, –∫–æ–≥–¥–∞ –≤–µ–¥—É—â–∏–π –Ω–∞–∑–æ–≤—ë—Ç –≤–∞—à–µ –∏–º—è.</small></p>
        
        <button class="back-btn" onclick="window.location.href = 'index.html'">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="back-btn" onclick="toggleDebug()" style="font-size: 12px; padding: 5px 10px;">üêõ –û—Ç–ª–∞–¥–∫–∞</button>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        function logDebug(message) {
            const debugLog = document.getElementById('debugLog');
            const debugInfo = document.getElementById('debugInfo');
            if (debugLog) {
                debugLog.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            }
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // ==== –í–°–¢–ê–í–¨–¢–ï –í–ê–®–£ REAL –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Æ FIREBASE –ó–î–ï–°–¨ ====
        const firebaseConfig = {
            apiKey: "AIzaSyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:aaaaaaaaaaaaaaaa"
        };
        // ==== –ö–û–ù–ï–¶ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ====

        logDebug('–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏...');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            logDebug('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
            logDebug('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ' + error.message);
            showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        }

        const participantId = 'user_' + Math.random().toString(36).substr(2, 9);
        let participantName = '';
        let handRaised = false;

        // –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏
        try {
            participantName = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:", "–£—á–∞—Å—Ç–Ω–∏–∫") || "–ê–Ω–æ–Ω–∏–º–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫";
            logDebug('–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞: ' + participantName);
        } catch (error) {
            participantName = "–ê–Ω–æ–Ω–∏–º–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫";
            logDebug('–ò–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ' + participantName);
        }

        const raiseHandBtn = document.getElementById('raiseHandBtn');
        const statusElement = document.getElementById('status');

        function showError(message) {
            statusElement.textContent = "‚ùå " + message;
            statusElement.className = "error";
        }

        function showSuccess(message) {
            statusElement.textContent = "‚úÖ " + message;
            statusElement.className = "success";
        }

        function showInfo(message) {
            statusElement.textContent = "üîÑ " + message;
            statusElement.className = "info";
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–¥–Ω—è–ª–∏ –ª–∏ –º—ã —É–∂–µ —Ä—É–∫—É
        if (database) {
            try {
                database.ref('queue').once('value').then((snapshot) => {
                    const queue = snapshot.val();
                    logDebug('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–∏: ' + (queue ? Object.keys(queue).length : 0) + ' —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
                    
                    if (queue) {
                        const existing = Object.values(queue).find(p => p.id === participantId);
                        if (existing) {
                            handRaised = true;
                            raiseHandBtn.disabled = true;
                            showSuccess('–í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏! –û–∂–∏–¥–∞–π—Ç–µ...');
                            logDebug('–£—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏');
                        }
                    }
                }).catch(error => {
                    logDebug('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—á–µ—Ä–µ–¥–∏: ' + error.message);
                });
            } catch (error) {
                logDebug('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—á–µ—Ä–µ–¥–∏: ' + error.message);
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–±—Ä–æ—Å –æ—á–µ—Ä–µ–¥–∏
        if (database) {
            try {
                database.ref('resetFlag').on('value', (snapshot) => {
                    const resetValue = snapshot.val();
                    logDebug('–ü–æ–ª—É—á–µ–Ω —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞: ' + resetValue);
                    
                    if (resetValue === true) {
                        handRaised = false;
                        raiseHandBtn.disabled = false;
                        showInfo('–ù–∞—á–∞—Ç –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å! –ú–æ–∂–µ—Ç–µ —Å–Ω–æ–≤–∞ –ø–æ–¥–Ω—è—Ç—å —Ä—É–∫—É.');
                        logDebug('–û—á–µ—Ä–µ–¥—å —Å–±—Ä–æ—à–µ–Ω–∞, –∫–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞');
                        
                        setTimeout(() => {
                            if (!handRaised) {
                                statusElement.textContent = "";
                            }
                        }, 5000);
                    }
                });
            } catch (error) {
                logDebug('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —Å–±—Ä–æ—Å–∞: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–Ω—è—Ç–∏—è —Ä—É–∫–∏
        async function raiseHand() {
            logDebug('–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥–Ω—è—Ç—å —Ä—É–∫—É"');
            
            if (handRaised) {
                logDebug('–†—É–∫–∞ —É–∂–µ –ø–æ–¥–Ω—è—Ç–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º');
                return;
            }
            
            if (!database) {
                showError('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                logDebug('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                return;
            }
            
            try {
                logDebug('–ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–Ω—è—Ç–∏—è —Ä—É–∫–∏...');
                
                handRaised = true;
                raiseHandBtn.disabled = true;
                showSuccess('–ü–æ–¥–Ω–∏–º–∞–µ–º —Ä—É–∫—É...');
                logDebug('–ö–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞');

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –≤ Firebase
                logDebug('–î–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');
                const newParticipantRef = database.ref('queue').push();
                
                await newParticipantRef.set({
                    id: participantId,
                    name: participantName,
                    timestamp: Date.now()
                });
                
                logDebug('–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å —Å ID: ' + newParticipantRef.key);
                showSuccess('–í—ã –ø–æ–¥–Ω—è–ª–∏ —Ä—É–∫—É! –û–∂–∏–¥–∞–π—Ç–µ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏.');
                
            } catch (error) {
                logDebug('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–Ω—è—Ç–∏–∏ —Ä—É–∫–∏: ' + error.message);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                handRaised = false;
                raiseHandBtn.disabled = false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        if (database) {
            try {
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    logDebug('–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Firebase: ' + (connected ? 'connected' : 'disconnected'));
                });
            } catch (error) {
                logDebug('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        } else {
            logDebug('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            showError('–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º');
        }

        raiseHandBtn.addEventListener('click', raiseHand);
        logDebug('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
    </script>
</body>
</html>